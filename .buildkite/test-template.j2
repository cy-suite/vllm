{% set docker_image = "us-central1-docker.pkg.dev/vllm-405802/vllm-ci-test-repo/vllm-test:$BUILDKITE_COMMIT" %}
{% set default_num_gpu = 1 %}
{% set default_working_dir = "/vllm-workspace/tests" %}

steps:
  - label: "check changes path"
    key: "check-path"
    plugins:
        - monebag/monorepo-diff#v2.5.9:
            diff: "git diff --name-only HEAD~1"
            watch:
              - path: ".buildkite/"
                config:
                  label: ":docker: build image"
                  commands: 
                    - "docker build --build-arg max_jobs=16 --tag {{ docker_image }} --target test --progress plain ."
                    - "docker push {{ docker_image }}"
                  env:
                    DOCKER_BUILDKIT: "1"
                  retry:
                    automatic:
                      - exit_status: -1  # Agent was lost
                        limit: 5
                      - exit_status: -10  # Agent was lost
                        limit: 5
