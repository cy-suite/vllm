{% set docker_image = "public.ecr.aws/q9t5s3a7/vllm-ci-test-repo:$BUILDKITE_COMMIT" %}
{% set default_working_dir = "/vllm-workspace/tests" %}
{% set hf_home = "~/.cache/huggingface" %}

steps:
  {% for step in steps %}
  {% if step.num_nodes >= 2 %}
  - label: Multinode test
    priority: 1000
    agents:
      queue: gpu_4_queue
    commands:
      - docker network create --subnet=192.168.10.0/24 docker-net
      {% for node in range(step.num_nodes) %}
      - docker run {% if not loop.last %}-d {%endif %} --gpus '"device={% for gpu in range(step.num_gpus) %}{{ node * step.num_gpus + gpu }}{% if not loop.last %},{% endif %}{% endfor %}"' -it --network docker-net --ip 192.168.10.{{ 10 + node }} public.ecr.aws/q9t5s3a7/vllm-ci-test-repo:614aa5120303ab09be78fb1db669da198cc43b02 /bin/bash -c "{{ step.commands[node] | replace('"', '\\"') }}"
      {% endfor %}
  {% endif %}
  {% endfor %}