{% set docker_image = "public.ecr.aws/q9t5s3a7/vllm-ci-test-repo:$BUILDKITE_COMMIT" %}
{% set default_working_dir = "/vllm-workspace/tests" %}
{% set hf_home = "~/.cache/huggingface" %}

steps:
  {% for step in steps %}
  {% if step.num_nodes >= 2 %}
  - label: Multinode test
    priority: 1000
    agents:
      queue: gpu_4_queue
    commands:
      - docker network create --subnet=192.168.10.0/24 docker-net
      {% for node in range(step.num_nodes) %}
      - echo "Starting node {{ node }}"
      - docker run -d --name node{{node}} --gpus '"device={% for gpu in range(step.num_gpus) %}{{ node * step.num_gpus + gpu }}{% if not loop.last %},{% endif %}{% endfor %}"' -it --network docker-net --ip 192.168.10.{{ 10 + node }} {{ docker_image }} tail -f /dev/null
      {% endfor %}
      {% for node in range(step.num_nodes) %}
      - echo "Running node {{ node }}"
      - docker exec {% if not loop.last %}-d{%endif %} node{{node}} /bin/bash -c "{{ step.commands[node] | replace('"', '\\"') }}"
      {% endfor %}
  {% endif %}
  {% endfor %}