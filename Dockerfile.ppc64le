FROM mambaorg/micromamba
ARG MAMBA_DOCKERFILE_ACTIVATE=1
USER root

ENV PATH="/usr/local/cargo/bin:/opt/conda/bin:$PATH"

RUN apt-get update -y && apt-get install -y git wget curl vim libnuma-dev libsndfile-dev libprotobuf-dev build-essential ffmpeg libsm6 libxext6 libgl1 libdnnl-dev 

# Some packages in requirements-cpu are installed here
# IBM provides optimized packages for ppc64le processors in the open-ce project for mamba
# Currently these may not be available for venv or pip directly
RUN micromamba install -y -n base -c https://ftp.osuosl.org/pub/open-ce/1.11.0-p10/ -c defaults python=3.10 torchvision-cpu=0.16.2 rust && micromamba clean --all --yes

<<<<<<< HEAD
COPY ./ /workspace/
WORKDIR /workspace/
=======
COPY ./ /workspace/vllm

WORKDIR /workspace/vllm
ARG GIT_REPO_CHECK=0
RUN --mount=type=bind,source=.git,target=.git \
    if [ "$GIT_REPO_CHECK" != 0 ]; then bash tools/check_repo.sh; fi
>>>>>>> a2c71c54... [CI/Build] remove .github from .dockerignore, add dirty repo check (#9375)

# These packages will be in rocketce eventually
<<<<<<< HEAD
RUN pip install -v cmake xformers torch==2.4.0 uvloop==0.20.0 -r requirements-cpu.txt --prefer-binary --extra-index-url https://repo.fury.io/mgiessing
=======
RUN --mount=type=cache,target=/root/.cache/pip  \
    pip install -v --prefer-binary --extra-index-url https://repo.fury.io/mgiessing \
        'cmake>=3.26' ninja packaging 'setuptools-scm>=8' wheel jinja2 \
        torch==2.3.1 \
        -r requirements-cpu.txt \
        xformers uvloop==0.20.0

RUN --mount=type=bind,source=.git,target=.git \
    VLLM_TARGET_DEVICE=cpu python3 setup.py install

WORKDIR /workspace/
>>>>>>> ee5f34b1... [CI/Build] use setuptools-scm to set __version__ (#4738)

RUN VLLM_TARGET_DEVICE=cpu pip install -e . --prefer-binary --extra-index-url https://repo.fury.io/mgiessing

ENTRYPOINT ["/opt/conda/bin/python3", "-m", "vllm.entrypoints.openai.api_server"]
